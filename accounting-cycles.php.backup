<?php
session_start();
require_once 'includes/db.php';
require_once 'includes/functions.php';

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
if (!isset($_SESSION['user_id'])) {
    $_SESSION['user_id'] = 1;
    $_SESSION['username'] = 'admin';
    $_SESSION['role'] = 'admin';
}

$pageTitle = 'Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©';

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
$userId = $_SESSION['user_id'];
$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
$stmt->execute([$userId]);
$user = $stmt->fetch();

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª
$stats = [];
try {
    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
    $stmt = $pdo->query("SELECT COUNT(*) as total FROM account_cycles");
    $stats['total'] = $stmt->fetch()['total'];
    
    // Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
    $stmt = $pdo->query("SELECT COUNT(*) as open FROM account_cycles WHERE status = 'open'");
    $stats['open'] = $stmt->fetch()['open'];
    
    // Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©
    $stmt = $pdo->query("SELECT COUNT(*) as closed FROM account_cycles WHERE status = 'closed'");
    $stats['closed'] = $stmt->fetch()['closed'];
    
    // Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
    $stmt = $pdo->query("SELECT COUNT(*) as under_review FROM account_cycles WHERE status = 'under_review'");
    $stats['under_review'] = $stmt->fetch()['under_review'];
} catch (Exception $e) {
    $stats = ['total' => 0, 'open' => 0, 'closed' => 0, 'under_review' => 0];
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª
$companies = [];
try {
    $stmt = $pdo->query("SELECT id, nameAr, nameEn FROM companies ORDER BY nameAr");
    $companies = $stmt->fetchAll();
} catch (Exception $e) {
    $companies = [];
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù…Ø¹ Ø§Ù„ØªØµÙÙŠØ©
$search = isset($_GET['search']) ? $_GET['search'] : '';
$statusFilter = isset($_GET['status']) ? $_GET['status'] : '';
$typeFilter = isset($_GET['type']) ? $_GET['type'] : '';
$companyFilter = isset($_GET['company']) ? $_GET['company'] : '';

$whereConditions = [];
$params = [];

if (!empty($search)) {
    $whereConditions[] = "(ac.nameAr LIKE ? OR ac.nameEn LIKE ?)";
    $params[] = "%$search%";
    $params[] = "%$search%";
}

if (!empty($statusFilter)) {
    $whereConditions[] = "ac.status = ?";
    $params[] = $statusFilter;
}

if (!empty($typeFilter)) {
    $whereConditions[] = "ac.type = ?";
    $params[] = $typeFilter;
}

if (!empty($companyFilter)) {
    $whereConditions[] = "ac.companyId = ?";
    $params[] = $companyFilter;
}

$whereClause = !empty($whereConditions) ? 'WHERE ' . implode(' AND ', $whereConditions) : '';

$sql = "SELECT 
            ac.*,
            c.nameAr as companyName,
            u.name as closedByName,
            (SELECT COUNT(*) FROM journals WHERE cycleId = ac.id) as journalCount,
            (SELECT COUNT(*) FROM period_balances WHERE cycleId = ac.id) as accountCount
        FROM account_cycles ac
        LEFT JOIN organizations c ON c.id = ac.companyId
        LEFT JOIN users u ON u.id = ac.closedBy
        $whereClause
        ORDER BY ac.startDate DESC";

$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$cycles = $stmt->fetchAll();

?>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $pageTitle; ?> - Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø¨Ø§Ø³ÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</title>
    
    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 0;
            overflow: hidden;
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            font-weight: 700;
            margin: 0;
            font-size: 2rem;
        }
        
        .page-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: none;
            height: 100%;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .stats-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .stats-card.total .icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats-card.open .icon {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .stats-card.closed .icon {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
        }
        
        .stats-card.review .icon {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stats-card p {
            color: #6c757d;
            margin: 0;
            font-size: 0.95rem;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .filter-section .form-control,
        .filter-section .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .filter-section .form-control:focus,
        .filter-section .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-outline-gradient {
            border: 2px solid #667eea;
            color: #667eea;
            background: white;
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-gradient:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .table {
            margin: 0;
        }
        
        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .table thead th {
            border: none;
            padding: 18px 15px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .table tbody tr {
            transition: all 0.3s ease;
        }
        
        .table tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }
        
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .badge {
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .badge-open {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .badge-closed {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
        }
        
        .badge-review {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .badge-monthly {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-quarterly {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .badge-yearly {
            background: #fff3e0;
            color: #e65100;
        }
        
        .action-btn {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            transition: all 0.3s ease;
            margin: 0 3px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-view {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .btn-view:hover {
            background: #1976d2;
            color: white;
        }
        
        .btn-edit {
            background: #fff3e0;
            color: #e65100;
        }
        
        .btn-edit:hover {
            background: #e65100;
            color: white;
        }
        
        .btn-close-cycle {
            background: #ffebee;
            color: #c62828;
        }
        
        .btn-close-cycle:hover {
            background: #c62828;
            color: white;
        }
        
        .btn-delete {
            background: #fce4ec;
            color: #d81b60;
        }
        
        .btn-delete:hover {
            background: #d81b60;
            color: white;
        }
        
        .modal-content {
            border-radius: 20px;
            border: none;
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 25px 30px;
        }
        
        .modal-header h5 {
            font-weight: 700;
            margin: 0;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-footer {
            border-top: 1px solid #f0f0f0;
            padding: 20px 30px;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.5rem;
            }
            
            .stats-card h3 {
                font-size: 2rem;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- Page Header -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-calendar-alt me-2"></i><?php echo $pageTitle; ?></h1>
                        <p class="mb-0">Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</p>
                    </div>
                    <div>
                        <a href="dashboard.php" class="btn btn-light">
                            <i class="fas fa-arrow-right me-2"></i>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="px-4 pb-4">
                <!-- Statistics Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="stats-card total">
                            <div class="icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h3><?php echo $stats['total']; ?></h3>
                            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stats-card open">
                            <div class="icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <h3><?php echo $stats['open']; ?></h3>
                            <p>Ø¯ÙˆØ±Ø§Øª Ù…ÙØªÙˆØ­Ø©</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stats-card closed">
                            <div class="icon">
                                <i class="fas fa-lock"></i>
                            </div>
                            <h3><?php echo $stats['closed']; ?></h3>
                            <p>Ø¯ÙˆØ±Ø§Øª Ù…Ù‚ÙÙ„Ø©</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stats-card review">
                            <div class="icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <h3><?php echo $stats['under_review']; ?></h3>
                            <p>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                        </div>
                    </div>
                </div>
                
                <!-- Filter Section -->
                <div class="filter-section">
                    <form method="GET" id="filterForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" name="search" 
                                       placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." 
                                       value="<?php echo htmlspecialchars($search); ?>">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" name="status">
                                    <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                    <option value="open" <?php echo $statusFilter == 'open' ? 'selected' : ''; ?>>Ù…ÙØªÙˆØ­</option>
                                    <option value="under_review" <?php echo $statusFilter == 'under_review' ? 'selected' : ''; ?>>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                    <option value="closed" <?php echo $statusFilter == 'closed' ? 'selected' : ''; ?>>Ù…Ù‚ÙÙ„</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" name="type">
                                    <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                                    <option value="monthly" <?php echo $typeFilter == 'monthly' ? 'selected' : ''; ?>>Ø´Ù‡Ø±ÙŠ</option>
                                    <option value="quarterly" <?php echo $typeFilter == 'quarterly' ? 'selected' : ''; ?>>Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                                    <option value="yearly" <?php echo $typeFilter == 'yearly' ? 'selected' : ''; ?>>Ø³Ù†ÙˆÙŠ</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" name="company">
                                    <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª</option>
                                    <?php foreach ($companies as $company): ?>
                                        <option value="<?php echo $company['id']; ?>" 
                                                <?php echo $companyFilter == $company['id'] ? 'selected' : ''; ?>>
                                            <?php echo htmlspecialchars($company['nameAr']); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-gradient w-100">
                                    <i class="fas fa-filter me-2"></i>ØªØµÙÙŠØ©
                                </button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addCycleModal">
                                    <i class="fas fa-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                                </button>
                                <a href="?<?php echo http_build_query(['company' => $companyFilter]); ?>" class="btn btn-outline-gradient">
                                    <i class="fas fa-redo me-2"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                                </a>
                                <button type="button" class="btn btn-outline-gradient" onclick="createYearlyCycles()">
                                    <i class="fas fa-calendar-plus me-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø§Øª Ø³Ù†ÙˆÙŠØ©
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Cycles Table -->
                <div class="table-container">
                    <?php if (empty($cycles)): ?>
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</h3>
                            <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø§Øª Ø³Ù†ÙˆÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                        </div>
                    <?php else: ?>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="20%">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©</th>
                                    <th width="15%">Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th>
                                    <th width="10%">Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th width="15%">Ø§Ù„ÙØªØ±Ø©</th>
                                    <th width="10%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th width="10%">Ø§Ù„Ù‚ÙŠÙˆØ¯</th>
                                    <th width="15%">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($cycles as $index => $cycle): ?>
                                    <tr>
                                        <td><?php echo $index + 1; ?></td>
                                        <td>
                                            <strong><?php echo htmlspecialchars($cycle['name']); ?></strong>
                                            <?php if ($cycle['nameEn']): ?>
                                                <br><small class="text-muted"><?php echo htmlspecialchars($cycle['nameEn']); ?></small>
                                            <?php endif; ?>
                                        </td>
                                        <td><?php echo htmlspecialchars($cycle['companyName'] ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'); ?></td>
                                        <td>
                                            <?php
                                            $typeLabels = [
                                                'monthly' => 'Ø´Ù‡Ø±ÙŠ',
                                                'quarterly' => 'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ',
                                                'yearly' => 'Ø³Ù†ÙˆÙŠ'
                                            ];
                                            $typeClass = 'badge-' . $cycle['type'];
                                            ?>
                                            <span class="badge <?php echo $typeClass; ?>">
                                                <?php echo $typeLabels[$cycle['type']] ?? $cycle['type']; ?>
                                            </span>
                                        </td>
                                        <td>
                                            <small>
                                                <?php echo date('Y-m-d', strtotime($cycle['startDate'])); ?>
                                                <br>Ø¥Ù„Ù‰<br>
                                                <?php echo date('Y-m-d', strtotime($cycle['endDate'])); ?>
                                            </small>
                                        </td>
                                        <td>
                                            <?php
                                            $statusLabels = [
                                                'open' => 'Ù…ÙØªÙˆØ­',
                                                'under_review' => 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                                                'closed' => 'Ù…Ù‚ÙÙ„'
                                            ];
                                            $statusClass = 'badge-' . str_replace('_', '', $cycle['status']);
                                            ?>
                                            <span class="badge <?php echo $statusClass; ?>">
                                                <?php echo $statusLabels[$cycle['status']] ?? $cycle['status']; ?>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                <?php echo $cycle['journalCount']; ?> Ù‚ÙŠØ¯
                                            </span>
                                        </td>
                                        <td>
                                            <button class="action-btn btn-view" 
                                                    onclick="viewCycle(<?php echo $cycle['id']; ?>)"
                                                    title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <?php if ($cycle['status'] == 'open'): ?>
                                                <button class="action-btn btn-edit" 
                                                        onclick="editCycle(<?php echo $cycle['id']; ?>)"
                                                        title="ØªØ¹Ø¯ÙŠÙ„">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="action-btn btn-close-cycle" 
                                                        onclick="closeCycle(<?php echo $cycle['id']; ?>)"
                                                        title="Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø¯ÙˆØ±Ø©">
                                                    <i class="fas fa-lock"></i>
                                                </button>
                                            <?php endif; ?>
                                            <?php if ($cycle['status'] == 'closed' && $user['role'] == 'admin'): ?>
                                                <button class="action-btn btn-edit" 
                                                        onclick="reopenCycle(<?php echo $cycle['id']; ?>)"
                                                        title="Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­">
                                                    <i class="fas fa-unlock"></i>
                                                </button>
                                            <?php endif; ?>
                                            <?php if ($cycle['journalCount'] == 0): ?>
                                                <button class="action-btn btn-delete" 
                                                        onclick="deleteCycle(<?php echo $cycle['id']; ?>)"
                                                        title="Ø­Ø°Ù">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Cycle Modal -->
    <div class="modal fade" id="addCycleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addCycleForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© (Ø¹Ø±Ø¨ÙŠ) *</label>
                                <input type="text" class="form-control" name="name" required 
                                       placeholder="Ù…Ø«Ø§Ù„: ÙŠÙ†Ø§ÙŠØ± 2025">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© (English)</label>
                                <input type="text" class="form-control" name="nameEn" 
                                       placeholder="Example: January 2025">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ø§Ù„Ù…Ø¤Ø³Ø³Ø© *</label>
                                <select class="form-select" name="companyId" required>
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</option>
                                    <?php foreach ($companies as $company): ?>
                                        <option value="<?php echo $company['id']; ?>">
                                            <?php echo htmlspecialchars($company['nameAr']); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ±Ø© *</label>
                                <select class="form-select" name="type" required>
                                    <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                                    <option value="quarterly">Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                                    <option value="yearly">Ø³Ù†ÙˆÙŠ</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                                <select class="form-select" name="status">
                                    <option value="open">Ù…ÙØªÙˆØ­</option>
                                    <option value="under_review">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© *</label>
                                <input type="date" class="form-control" name="startDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© *</label>
                                <input type="date" class="form-control" name="endDate" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea class="form-control" name="notes" rows="3" 
                                          placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-gradient" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
                        </button>
                        <button type="submit" class="btn btn-gradient">
                            <i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±Ø©
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Cycle Modal -->
    <div class="modal fade" id="editCycleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editCycleForm">
                    <input type="hidden" name="cycleId" id="edit_cycleId">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© (Ø¹Ø±Ø¨ÙŠ) *</label>
                                <input type="text" class="form-control" name="name" id="edit_name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© (English)</label>
                                <input type="text" class="form-control" name="nameEn" id="edit_nameEn">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ø§Ù„Ù…Ø¤Ø³Ø³Ø© *</label>
                                <select class="form-select" name="companyId" id="edit_companyId" required>
                                    <?php foreach ($companies as $company): ?>
                                        <option value="<?php echo $company['id']; ?>">
                                            <?php echo htmlspecialchars($company['nameAr']); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ±Ø© *</label>
                                <select class="form-select" name="type" id="edit_type" required>
                                    <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                                    <option value="quarterly">Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                                    <option value="yearly">Ø³Ù†ÙˆÙŠ</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                                <select class="form-select" name="status" id="edit_status">
                                    <option value="open">Ù…ÙØªÙˆØ­</option>
                                    <option value="under_review">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© *</label>
                                <input type="date" class="form-control" name="startDate" id="edit_startDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© *</label>
                                <input type="date" class="form-control" name="endDate" id="edit_endDate" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea class="form-control" name="notes" id="edit_notes" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-gradient" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
                        </button>
                        <button type="submit" class="btn btn-gradient">
                            <i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- View Cycle Modal -->
    <div class="modal fade" id="viewCycleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="cycleDetailsContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
        $('#addCycleForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            formData.append('action', 'add');
            
            $.ajax({
                url: 'api/accounting-cycles.php',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!',
                            text: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
                            confirmButtonColor: '#667eea'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ø®Ø·Ø£!',
                            text: response.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ±Ø©',
                            confirmButtonColor: '#667eea'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ø®Ø·Ø£!',
                        text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…',
                        confirmButtonColor: '#667eea'
                    });
                }
            });
        });
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙˆØ±Ø©
        function editCycle(id) {
            $.ajax({
                url: 'api/accounting-cycles.php?action=get&id=' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const cycle = response.data;
                        $('#edit_cycleId').val(cycle.id);
                        $('#edit_name').val(cycle.name);
                        $('#edit_nameEn').val(cycle.nameEn);
                        $('#edit_companyId').val(cycle.companyId);
                        $('#edit_type').val(cycle.type);
                        $('#edit_status').val(cycle.status);
                        $('#edit_startDate').val(cycle.startDate);
                        $('#edit_endDate').val(cycle.endDate);
                        $('#edit_notes').val(cycle.notes);
                        
                        $('#editCycleModal').modal('show');
                    }
                }
            });
        }
        
        $('#editCycleForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            formData.append('action', 'update');
            
            $.ajax({
                url: 'api/accounting-cycles.php',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!',
                            text: 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­',
                            confirmButtonColor: '#667eea'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ø®Ø·Ø£!',
                            text: response.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
                            confirmButtonColor: '#667eea'
                        });
                    }
                }
            });
        });
        
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©
        function viewCycle(id) {
            $('#viewCycleModal').modal('show');
            
            $.ajax({
                url: 'api/accounting-cycles.php?action=view&id=' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        $('#cycleDetailsContent').html(response.html);
                    } else {
                        $('#cycleDetailsContent').html('<div class="alert alert-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>');
                    }
                }
            });
        }
        
        // Ø¥Ù‚ÙØ§Ù„ Ø¯ÙˆØ±Ø©
        function closeCycle(id) {
            Swal.fire({
                title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„',
                text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù‚ÙØ§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©ØŸ Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#667eea',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø£Ù‚ÙÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                input: 'textarea',
                inputPlaceholder: 'Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
                inputAttributes: {
                    'aria-label': 'Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù‚ÙØ§Ù„'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();
                    formData.append('action', 'close');
                    formData.append('cycleId', id);
                    formData.append('reason', result.value || '');
                    
                    $.ajax({
                        url: 'api/accounting-cycles.php',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'ØªÙ… Ø§Ù„Ø¥Ù‚ÙØ§Ù„!',
                                    text: 'ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­',
                                    confirmButtonColor: '#667eea'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Ø®Ø·Ø£!',
                                    text: response.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù‚ÙØ§Ù„',
                                    confirmButtonColor: '#667eea'
                                });
                            }
                        }
                    });
                }
            });
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø¯ÙˆØ±Ø©
        function reopenCycle(id) {
            Swal.fire({
                title: 'ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­',
                text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©ØŸ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#667eea',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø£Ø¹Ø¯ Ø§Ù„ÙØªØ­',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                input: 'textarea',
                inputPlaceholder: 'Ø³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­',
                inputAttributes: {
                    'aria-label': 'Ø³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­'
                },
                inputValidator: (value) => {
                    if (!value) {
                        return 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­!'
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();
                    formData.append('action', 'reopen');
                    formData.append('cycleId', id);
                    formData.append('reason', result.value);
                    
                    $.ajax({
                        url: 'api/accounting-cycles.php',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­!',
                                    text: 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­',
                                    confirmButtonColor: '#667eea'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Ø®Ø·Ø£!',
                                    text: response.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­',
                                    confirmButtonColor: '#667eea'
                                });
                            }
                        }
                    });
                }
            });
        }
        
        // Ø­Ø°Ù Ø¯ÙˆØ±Ø©
        function deleteCycle(id) {
            Swal.fire({
                title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#667eea',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();
                    formData.append('action', 'delete');
                    formData.append('cycleId', id);
                    
                    $.ajax({
                        url: 'api/accounting-cycles.php',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                                    text: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­',
                                    confirmButtonColor: '#667eea'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Ø®Ø·Ø£!',
                                    text: response.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù',
                                    confirmButtonColor: '#667eea'
                                });
                            }
                        }
                    });
                }
            });
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø§Øª Ø³Ù†ÙˆÙŠØ©
        function createYearlyCycles() {
            Swal.fire({
                title: 'Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø§Øª Ø³Ù†ÙˆÙŠØ©',
                html: `
                    <div class="mb-3">
                        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
                        <input type="number" id="year_input" class="form-control" 
                               value="${new Date().getFullYear()}" min="2020" max="2050">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¤Ø³Ø³Ø©:</label>
                        <select id="company_input" class="form-select">
                            <?php foreach ($companies as $company): ?>
                                <option value="<?php echo $company['id']; ?>">
                                    <?php echo htmlspecialchars($company['nameAr']); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#667eea',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                preConfirm: () => {
                    const year = document.getElementById('year_input').value;
                    const companyId = document.getElementById('company_input').value;
                    
                    if (!year || !companyId) {
                        Swal.showValidationMessage('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ù…Ø¤Ø³Ø³Ø©');
                        return false;
                    }
                    
                    return { year: year, companyId: companyId };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();
                    formData.append('action', 'create_yearly');
                    formData.append('year', result.value.year);
                    formData.append('companyId', result.value.companyId);
                    
                    $.ajax({
                        url: 'api/accounting-cycles.php',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!',
                                    text: response.message || 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
                                    confirmButtonColor: '#667eea'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Ø®Ø·Ø£!',
                                    text: response.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡',
                                    confirmButtonColor: '#667eea'
                                });
                            }
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>
